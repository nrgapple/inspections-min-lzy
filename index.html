<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Minimal Out-of-the-Box Inspection App</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 1rem;
      }
      .hidden {
        display: none;
      }
      textarea {
        width: 100%;
        height: 60px;
      }
      img {
        max-width: 200px;
        display: block;
        margin: 5px 0;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <h1>Inspection App (GitHub Issues + Imgur)</h1>

    <!-- Super naive "Auth" -->
    <div id="authDiv">
      <p>Enter Username/Password to Log In:</p>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
      <button id="logoutBtn" class="hidden">Logout</button>
      <p id="authStatus"></p>
    </div>

    <!-- Lender Section -->
    <div id="lenderDiv" class="hidden">
      <h2>Lender Dashboard</h2>
      <label>Inspection Title: <input type="text" id="titleInput" /></label
      ><br /><br />
      <label>Line Items (JSON array):</label><br />
      <textarea id="itemsInput">
[{"name":"Walls","percentage":0},{"name":"Roof","percentage":0}]</textarea
      ><br />
      <label
        >Inspector Username: <input type="text" id="inspectorUsername" /></label
      ><br /><br />
      <button id="createBtn">Create Inspection</button>
      <h3>My Inspections</h3>
      <ul id="lenderList"></ul>
    </div>

    <!-- Inspector Section -->
    <div id="inspectorDiv" class="hidden">
      <h2>Inspector Dashboard</h2>
      <ul id="inspectorList"></ul>
    </div>

    <script>
      /*** 1) Minimal "user database" in code ***/
      const users = [
        {
          username: "lender1",
          password: "pass1",
          role: "lender",
          userId: "lender1",
        },
        {
          username: "inspector1",
          password: "pass2",
          role: "inspector",
          userId: "inspector1",
        },
      ];
      /*
        userId = the "unique ID" we'll store in the GitHub Issue body so we know who it belongs to.
        For a real app, you'd have real auth. This is a silly example for minimal code sake.
      */

      /*** 2) Our "logged in" user (null if none) ***/
      let currentUser = null;

      /*** 3) GitHub & Imgur config (WARNING: exposing tokens in client!) ***/
      const GH_REPO_OWNER = "nrgapple";
      const GH_REPO_NAME = "inspections-min-lzy";
      const GH_PAT =
        "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"; // personal access token with repo scope
      const IMGUR_CLIENT_ID = "54d212003c88f26"; // from Imgur application

      /*** 4) Dom elements ***/
      const usernameEl = document.getElementById("username");
      const passwordEl = document.getElementById("password");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const authStatus = document.getElementById("authStatus");

      const lenderDiv = document.getElementById("lenderDiv");
      const titleInput = document.getElementById("titleInput");
      const itemsInput = document.getElementById("itemsInput");
      const inspectorUsername = document.getElementById("inspectorUsername");
      const createBtn = document.getElementById("createBtn");
      const lenderList = document.getElementById("lenderList");

      const inspectorDiv = document.getElementById("inspectorDiv");
      const inspectorList = document.getElementById("inspectorList");

      /*** 5) "Login" logic ***/
      loginBtn.onclick = () => {
        const uname = usernameEl.value.trim();
        const pword = passwordEl.value.trim();
        const u = users.find(
          (x) => x.username === uname && x.password === pword
        );
        if (!u) {
          authStatus.textContent = "Invalid username/password";
          return;
        }
        currentUser = u;
        authStatus.textContent = `Logged in as ${u.username} (role: ${u.role})`;
        loginBtn.disabled = true;
        usernameEl.disabled = true;
        passwordEl.disabled = true;
        logoutBtn.classList.remove("hidden");
        if (u.role === "lender") {
          lenderDiv.classList.remove("hidden");
          inspectorDiv.classList.add("hidden");
          loadLenderInspections();
        } else if (u.role === "inspector") {
          inspectorDiv.classList.remove("hidden");
          lenderDiv.classList.add("hidden");
          loadInspectorInspections();
        }
      };

      logoutBtn.onclick = () => {
        currentUser = null;
        authStatus.textContent = "Logged out";
        loginBtn.disabled = false;
        usernameEl.disabled = false;
        passwordEl.disabled = false;
        usernameEl.value = "";
        passwordEl.value = "";
        logoutBtn.classList.add("hidden");
        lenderDiv.classList.add("hidden");
        inspectorDiv.classList.add("hidden");
      };

      /*** 6) Lender create an inspection => create GitHub Issue ***/
      createBtn.onclick = async () => {
        if (!currentUser) return;
        const title = titleInput.value.trim();
        if (!title) {
          alert("Need a title");
          return;
        }
        let items;
        try {
          items = JSON.parse(itemsInput.value);
        } catch (e) {
          alert("Items must be valid JSON");
          return;
        }
        // find inspector user
        const insU = users.find(
          (x) =>
            x.username === inspectorUsername.value.trim() &&
            x.role === "inspector"
        );
        if (!insU) {
          alert("Inspector username not found");
          return;
        }

        // We'll store everything in the GitHub issue "body" as JSON
        const bodyData = {
          lenderId: currentUser.userId,
          inspectorId: insU.userId,
          lineItems: items,
          status: "OPEN",
          photos: [],
        };
        const ghUrl = `https://api.github.com/repos/${GH_REPO_OWNER}/${GH_REPO_NAME}/issues`;
        // POST to create an issue
        const resp = await fetch(ghUrl, {
          method: "POST",
          headers: {
            Authorization: `token ${GH_PAT}`,
            Accept: "application/vnd.github.v3+json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            title: title,
            body: JSON.stringify(bodyData),
          }),
        });
        const data = await resp.json();
        if (!resp.ok) {
          console.error(data);
          alert("Error creating issue");
          return;
        }
        alert("Inspection created!");
        loadLenderInspections();
      };

      /*** 7) Lender loads their inspections => list GitHub issues, filter by lenderId in body. ***/
      async function loadLenderInspections() {
        if (!currentUser) return;
        lenderList.innerHTML = "Loading...";
        // List all issues
        const ghUrl = `https://api.github.com/repos/${GH_REPO_OWNER}/${GH_REPO_NAME}/issues?state=all&per_page=100`;
        const resp = await fetch(ghUrl, {
          headers: { Authorization: `token ${GH_PAT}` },
        });
        const issues = await resp.json();
        if (!resp.ok) {
          console.error(issues);
          lenderList.innerHTML = "Error loading";
          return;
        }
        lenderList.innerHTML = "";
        issues.forEach((issue) => {
          // parse the body
          let bodyData;
          try {
            bodyData = JSON.parse(issue.body);
          } catch (e) {
            return;
          }
          // filter for lenderId
          if (bodyData.lenderId === currentUser.userId) {
            const li = document.createElement("li");
            li.innerHTML = `
              <strong>${issue.title}</strong> [#${issue.number}] - Status: ${bodyData.status}<br/>
              Inspector: ${bodyData.inspectorId}<br/>
              <button onclick="viewInspection(${issue.number})">View</button>
            `;
            lenderList.appendChild(li);
          }
        });
      }

      /*** 8) Inspector loads assigned => filter by inspectorId in body. ***/
      async function loadInspectorInspections() {
        if (!currentUser) return;
        inspectorList.innerHTML = "Loading...";
        const ghUrl = `https://api.github.com/repos/${GH_REPO_OWNER}/${GH_REPO_NAME}/issues?state=all&per_page=100`;
        const resp = await fetch(ghUrl, {
          headers: { Authorization: `token ${GH_PAT}` },
        });
        const issues = await resp.json();
        if (!resp.ok) {
          inspectorList.innerHTML = "Error loading issues";
          return;
        }
        inspectorList.innerHTML = "";
        issues.forEach((issue) => {
          let bodyData;
          try {
            bodyData = JSON.parse(issue.body);
          } catch (e) {
            return;
          }
          if (bodyData.inspectorId === currentUser.userId) {
            const li = document.createElement("li");
            li.innerHTML = `
              <strong>${issue.title}</strong> [#${issue.number}] - Status: ${bodyData.status}<br/>
              <button onclick="completeInspection(${issue.number})">Complete / Update</button>
            `;
            inspectorList.appendChild(li);
          }
        });
      }

      /*** 9) Lender "View" -> basic popup ***/
      window.viewInspection = async function (issueNumber) {
        const issueData = await getIssueData(issueNumber);
        if (!issueData) return;
        const { bodyData } = issueData;
        let msg = `STATUS: ${bodyData.status}\nINSPECTOR: ${bodyData.inspectorId}\n\nLINE ITEMS:\n`;
        bodyData.lineItems.forEach((i) => {
          msg += `- ${i.name}: ${i.percentage}%\n`;
        });
        msg += `\nPHOTOS:\n`;
        if (!bodyData.photos || bodyData.photos.length === 0) {
          msg += "No photos";
        } else {
          bodyData.photos.forEach((url) => {
            msg += url + "\n";
          });
        }
        alert(msg);
      };

      /*** 10) Inspector "Complete / Update" -> set new percentages, optional photo. ***/
      window.completeInspection = async function (issueNumber) {
        // 1) fetch current issue data
        const issueData = await getIssueData(issueNumber);
        if (!issueData) return;
        const { title, bodyData } = issueData;
        // prompt new percentages
        const arrStr = prompt(
          "Enter new percentages (JSON array) or blank to skip",
          ""
        );
        if (arrStr) {
          try {
            const arr = JSON.parse(arrStr);
            arr.forEach((val, idx) => {
              if (bodyData.lineItems[idx]) {
                bodyData.lineItems[idx].percentage = val;
              }
            });
          } catch (e) {
            alert("Invalid JSON array");
          }
        }
        // if all 100 => status = COMPLETED
        const allComplete = bodyData.lineItems.every(
          (i) => i.percentage >= 100
        );
        bodyData.status = allComplete ? "COMPLETED" : "OPEN";

        // optional photo upload
        const file = await pickPhoto();
        if (file) {
          const imgUrl = await uploadToImgur(file);
          if (imgUrl) {
            bodyData.photos.push(imgUrl);
          }
        }

        // 2) update GitHub Issue
        await updateIssue(issueNumber, title, bodyData);
        alert("Inspection updated!");
        // refresh inspector list
        loadInspectorInspections();
      };

      /*** helper: getIssueData ***/
      async function getIssueData(issueNumber) {
        const ghUrl = `https://api.github.com/repos/${GH_REPO_OWNER}/${GH_REPO_NAME}/issues/${issueNumber}`;
        const resp = await fetch(ghUrl, {
          headers: { Authorization: `token ${GH_PAT}` },
        });
        const issue = await resp.json();
        if (!resp.ok) {
          console.error(issue);
          alert("Error fetching issue");
          return null;
        }
        let bodyData;
        try {
          bodyData = JSON.parse(issue.body);
        } catch (e) {
          alert("Issue body parse error");
          return null;
        }
        return { title: issue.title, bodyData };
      }

      /*** helper: updateIssue ***/
      async function updateIssue(issueNumber, newTitle, newBodyData) {
        const ghUrl = `https://api.github.com/repos/${GH_REPO_OWNER}/${GH_REPO_NAME}/issues/${issueNumber}`;
        const resp = await fetch(ghUrl, {
          method: "PATCH",
          headers: {
            Authorization: `token ${GH_PAT}`,
            Accept: "application/vnd.github.v3+json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            title: newTitle,
            body: JSON.stringify(newBodyData),
          }),
        });
        const data = await resp.json();
        if (!resp.ok) {
          console.error(data);
          alert("Error updating issue");
          return null;
        }
        return data;
      }

      /*** helper: pickPhoto ***/
      function pickPhoto() {
        return new Promise((resolve) => {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.onchange = () => {
            if (input.files && input.files[0]) {
              resolve(input.files[0]);
            } else {
              resolve(null);
            }
          };
          input.click();
        });
      }

      /*** helper: uploadToImgur ***/
      async function uploadToImgur(file) {
        const formData = new FormData();
        formData.append("image", file);
        // Anonymous upload
        const resp = await fetch("https://api.imgur.com/3/upload", {
          method: "POST",
          headers: { Authorization: `Client-ID ${IMGUR_CLIENT_ID}` },
          body: formData,
        });
        const json = await resp.json();
        if (json.success) {
          return json.data.link; // The public link
        } else {
          alert("Imgur upload failed");
          console.error(json);
          return null;
        }
      }
    </script>
  </body>
</html>
